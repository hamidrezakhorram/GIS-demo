{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Location Map</title>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/css/ol.css" type="text/css">
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 280px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .popup-content {
            margin-bottom: 10px;
        }
        .popup-media {
            margin-top: 10px;
        }
        .popup-media img {
            max-width: 100%;
            height: auto;
            margin-bottom: 5px;
        }
        .popup-media audio, .popup-media video {
            width: 100%;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="popup" class="ol-popup">
        <div id="popup-content"></div>
    </div>

    <!-- OpenLayers JavaScript -->
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.15.1/build/ol.js"></script>
    <script>
        // Function to parse PostGIS WKT format
        function parsePostGISPoint(wktString) {
            const match = wktString.match(/POINT \(([^ ]+) ([^)]+)\)/);
            if (match) {
                const lon = parseFloat(match[1]);
                const lat = parseFloat(match[2]);
                return [lon, lat];
            }
            throw new Error('Invalid POINT format');
        }

        // Create the map
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([51.3890, 35.6892]), // Tehran coordinates
                zoom: 13
            })
        });

        // Create a vector source and layer for markers
        const vectorSource = new ol.source.Vector();
        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: function(feature) {
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({
                            color: feature.get('point_type') === 'NEW' ? '#4CAF50' : '#FF5722'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 2
                        })
                    })
                });
            }
        });
        map.addLayer(vectorLayer);

        // Fetch locations from API
        fetch('/locations/api/points/')
            .then(response => response.json())
            .then(data => {
                const locations = data.results || data;
                
                locations.forEach(location => {
                    try {
                        const coordinates = parsePostGISPoint(location.geom);
                        const point = new ol.Feature({
                            geometry: new ol.geom.Point(
                                ol.proj.fromLonLat(coordinates)
                            ),
                            name: location.name,
                            id: location.id,
                            point_type: location.point_type,
                            image: location.image,
                            audio: location.audio,
                            video: location.video,
                            created_at: new Date(location.created_at).toLocaleDateString()
                        });
                        vectorSource.addFeature(point);
                    } catch (error) {
                        console.error(`Error processing location ${location.id}:`, error);
                    }
                });
                
                // Zoom to features extent if any features exist
                if (vectorSource.getFeatures().length > 0) {
                    map.getView().fit(vectorSource.getExtent(), {
                        padding: [100, 100, 100, 100],
                        maxZoom: 15
                    });
                }
            })
            .catch(error => console.error('Error fetching locations:', error));

        // Popup overlay
        const popup = new ol.Overlay({
            element: document.getElementById('popup'),
            positioning: 'bottom-center',
            stopEvent: false,
            offset: [0, -10]
        });
        map.addOverlay(popup);

        // Display popup on click
        map.on('click', function(evt) {
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            });

            if (feature) {
                const coordinates = feature.getGeometry().getCoordinates();
                popup.setPosition(coordinates);
                
                // Create popup content
                let content = `
                    <div class="popup-content">
                        <h3>${feature.get('name')}</h3>
                        <p>Status: ${feature.get('point_type')}</p>
                        <p>Created: ${feature.get('created_at')}</p>
                    </div>
                    <div class="popup-media">
                `;

                // Add image if available
                if (feature.get('image')) {
                    content += `<img src="${feature.get('image')}" alt="${feature.get('name')}">`;
                }

                // Add audio if available
                if (feature.get('audio')) {
                    content += `
                        <audio controls>
                            <source src="${feature.get('audio')}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    `;
                }

                // Add video if available
                if (feature.get('video')) {
                    content += `
                        <video controls>
                            <source src="${feature.get('video')}" type="video/mp4">
                            Your browser does not support the video element.
                        </video>
                    `;
                }

                content += '</div>';
                document.getElementById('popup-content').innerHTML = content;
            } else {
                popup.setPosition(undefined);
            }
        });

        // Change mouse cursor when over marker
        map.on('pointermove', function(e) {
            const pixel = map.getEventPixel(e.originalEvent);
            const hit = map.hasFeatureAtPixel(pixel);
            map.getTarget().style.cursor = hit ? 'pointer' : '';
        });

        // Add filter controls
        const filterContainer = document.createElement('div');
        filterContainer.className = 'filter-container';
        filterContainer.style.position = 'absolute';
        filterContainer.style.top = '10px';
        filterContainer.style.right = '10px';
        filterContainer.style.backgroundColor = 'white';
        filterContainer.style.padding = '10px';
        filterContainer.style.borderRadius = '4px';
        filterContainer.innerHTML = `
            <div>
                <label>Filter by type:</label>
                <select id="typeFilter">
                    <option value="">All</option>
                    <option value="NEW">New</option>
                    <option value="OLD">Old</option>
                </select>
            </div>
        `;
        map.getTargetElement().appendChild(filterContainer);

        // Add filter functionality
        document.getElementById('typeFilter').addEventListener('change', function(e) {
            const selectedType = e.target.value;
            vectorSource.getFeatures().forEach(feature => {
                feature.setStyle(null); // Reset to default style
                if (selectedType && feature.get('point_type') !== selectedType) {
                    feature.setStyle(new ol.style.Style({})); // Hide feature
                }
            });
        });
    </script>
</body>
</html>
